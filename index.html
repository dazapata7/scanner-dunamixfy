// Google Apps Script para el scanner de Dunamixfy
// Este código va en Extensiones > Apps Script

function doPost(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('database');
    
    // Si no existe la hoja 'database', crearla
    if (!sheet) {
      sheet = ss.insertSheet('database');
      sheet.appendRow(['Fecha/Hora', 'Operario', 'Código QR', 'Transportadora']);
    }
    
    // Recibir datos del formulario
    var operario = e.parameter.operario || 'Sin operario';
    var codigo = e.parameter.codigo || 'Sin código';
    var transportadora = e.parameter.transportadora || 'Sin transportadora';
    var fecha = Utilities.formatDate(new Date(), "GMT-5", "yyyy-MM-dd HH:mm:ss");
    
    // Agregar fila SIN columna "Repetido" (solo se guardan códigos únicos)
    sheet.appendRow([fecha, operario, codigo, transportadora]);
    
    return ContentService.createTextOutput('success');
    
  } catch(error) {
    Logger.log('Error: ' + error.toString());
    return ContentService.createTextOutput('error: ' + error.toString());
  }
}

// Endpoint GET para obtener todos los códigos existentes CON transportadora
function doGet(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('database');
    
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'success',
        codigos: [],
        codigosConTransportadora: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Obtener todos los datos (desde fila 2)
    var lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'success',
        codigos: [],
        codigosConTransportadora: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Columnas: Fecha/Hora (A), Operario (B), Código QR (C), Transportadora (D)
    var datos = sheet.getRange(2, 1, lastRow - 1, 4).getValues();
    
    var codigos = [];
    var codigosConTransportadora = [];
    
    for (var i = 0; i < datos.length; i++) {
      var codigo = datos[i][2]; // Columna C
      var transportadora = datos[i][3]; // Columna D
      
      codigos.push(codigo);
      codigosConTransportadora.push({
        codigo: codigo,
        transportadora: transportadora
      });
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      codigos: codigos,
      codigosConTransportadora: codigosConTransportadora,
      total: codigos.length
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch(error) {
    Logger.log('Error en GET: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Función de prueba
function testData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('database');
  
  if (!sheet) {
    sheet = ss.insertSheet('database');
    sheet.appendRow(['Fecha/Hora', 'Operario', 'Código QR', 'Transportadora']);
  }
  
  var fecha = Utilities.formatDate(new Date(), "GMT-5", "yyyy-MM-dd HH:mm:ss");
  sheet.appendRow([fecha, "Daniel", "TEST123456", "coordinadora"]);
  Logger.log('Prueba completada');
}
